<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth;">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
		<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
		<title>VATSIM-UK Alias Preview</title>
	</head>
	<body class="scroll-smooth">
		<div class="container mx-auto p-4" x-data="aliasApp">
			<div class="flex flex-col items-center justify-center">
				<h1 class="text-4xl text-center">Alias Preview</h1>
				<p class="text-center mb-4">
					This page is a preview of the aliases of open EuroScope sector files.
				</p>

				<div class="flex flex-col items-center">
					<template x-if="Number(selectedTemplateIndex) === -1">
						<p>Select division template</p>
					</template>

					<template x-if="Number(selectedTemplateIndex) !== -1">
						<div class="text-center">
							Loaded total of 
							<span x-text="aliases.length"></span> 
							aliases from 
							<img class="inline-block h-4 w-4 align-middle" x-bind:src="templates[Number(selectedTemplateIndex)].icon_url" alt="Logo"> 
							<span x-text="templates[Number(selectedTemplateIndex)].name"></span>
						</div>
					</template>

					<select class="w-64 p-2 my-4 border border-gray-400 rounded-md bg-white shadow-sm hover:border-gray-500 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition-all duration-100" x-model="selectedTemplateIndex" @change="fetchAliases">
						<option value="-1" class="text-gray-500">Select a template</option>
						<template x-for="(template, index) in templates">
							<option :value="index" class="py-2" x-text="template.name"></option>
						</template>
					</select>
				</div>

			</div>

			<div class="flex flex-row items-center justify-center">
				<input type="text" x-model="search" class="w-full p-2 my-2 border border-gray-400 rounded-md hover:border-gray-500 focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 transition-all duration-100" style="outline: none;" placeholder="Search..." />
				<button @click="clearSearch">
					<span class="material-symbols-outlined mt-2 mx-2">cancel</span>
				</button>
			</div>

			<template x-if="Number(selectedTemplateIndex) !== -1">
				<div class="text-center my-4">
					Showing <span x-text="filteredAliases.length"></span> filtered aliases
				<div>
			</template>

			<div class="grid grid-cols-4 font-bold text-lg p-2">
				<div class="flex flex-col items-center relative">
					<div class="flex items-center justify-center">
						<p>File</p>
						<button @click="toggleFilter('file')" class="focus:outline-none">
							<span class="material-symbols-outlined mt-2 mx-2">filter_alt</span>
						</button>

						<button @click="selectAll('files', true)" class="focus:outline-none">
							<span class="material-symbols-outlined mt-2 mx-2">filter_alt_off</span>
						</button>
					</div>
					<div
						x-show="fileFilterOpen"
						class="absolute bg-white border border-gray-300 rounded shadow-lg z-10 p-2 w-full"
						style="top: 100%"
						@click.away="fileFilterOpen = false"
					>
						<label class="flex items-center mb-2">
							<input
								type="checkbox"
								@click="selectAll('files', $event.target.checked)"
								:checked="areAllSelected('files')"
								class="form-checkbox"
							/>
							<span class="ml-2">Select All</span>
						</label>
						<template x-for="file in Array.from(files)">
							<label class="flex items-center">
								<input type="checkbox" x-model="activeFiles" :value="file" class="form-checkbox" />
								<span class="ml-2" x-text="file"></span>
							</label>
						</template>
					</div>
				</div>

				<div class="flex flex-col items-center relative">
					<div class="flex items-center justify-center">
						<p>Category</p>
						<button @click="toggleFilter('category')" class="focus:outline-none">
							<span class="material-symbols-outlined mt-2 mx-2">filter_alt</span>
						</button>

						<button @click="selectAll('categories', true)" class="focus:outline-none">
							<span class="material-symbols-outlined mt-2 mx-2">filter_alt_off</span>
						</button>
					</div>
					<div
						x-show="categoryFilterOpen"
						class="absolute bg-white border border-gray-300 rounded shadow-lg z-10 p-2 w-full"
						style="top: 100%"
						@click.away="categoryFilterOpen = false"
					>
						<label class="flex items-center mb-2">
							<input
								type="checkbox"
								@click="selectAll('categories', $event.target.checked)"
								:checked="areAllSelected('categories')"
								class="form-checkbox"
							/>
							<span class="ml-2">Select All</span>
						</label>
						<template x-for="category in Array.from(categories)">
							<label class="flex items-center">
								<input type="checkbox" x-model="activeCategories" :value="category" class="form-checkbox" />
								<span class="ml-2" x-text="category"></span>
							</label>
						</template>
					</div>
				</div>

				<p class="text-center">Alias</p>
				<p class="text-center">Text</p>
			</div>

			<span class="h-1 bg-gray-400 w-full block"></span>

			<div id="alias-list" class="flex flex-col">
				<template x-if="filteredAliases.length === 0">
					<div class="text-center p-4 text-gray-600">No results found</div>
				</template>
				<template x-for="alias in filteredAliases" :key="alias.file + alias.alias">
					<div class="grid grid-cols-4 items-center p-2 border-b border-gray-400">
						<div class="flex items-center justify-center">
							<button
								class="text-center text-blue-600 hover:text-blue-800 hover:underline mx-2"
								@click="applyFilter('file', alias.file, true)"
								x-text="alias.file"
							></button>
							<a :href="alias.fileHref" target="_blank">
								<span class="material-symbols-outlined mx-2 hover:text-blue-600 cursor-pointer">captive_portal</span>
							</a>
						</div>

						<div class="flex items-center justify-center">
							<button
								class="text-center text-blue-600 hover:text-blue-800 hover:underline mx-2"
								@click="applyFilter('category', alias.category, true)"
								x-text="alias.category"
							></button>
						</div>

						<p class="text-center" x-html="highlight(alias.alias)"></p>
						<p class="text-center" x-html="highlight(alias.text)"></p>
					</div>
				</template>
			</div>

			<span class="h-1 bg-gray-400 w-full block"></span>

			back to top button

			<button style="position: fixed; bottom: 20px; right: 20px;" @click="window.scrollTo(0, 0)" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">
				<span class="material-symbols-outlined">arrow_upward</span>
			</button>
		</div>

		<script>
			function aliasApp() {
				return {
					aliases: [],
					files: new Set(),
					categories: new Set(),
					activeFiles: [],
					activeCategories: [],
					search: "",
					status: "No template selected...",
					fileFilterOpen: false,
					categoryFilterOpen: false,
					templates: [],
					selectedTemplateIndex: -1,

					async fetchTemplates() {
						const res = await fetch("preview-templates.json");

						if (!res.ok) {
							alert("Failed to load templates");
							return;
						}

						this.templates = await res.json();
					},

					async fetchAliases() {
						this.aliases = [];
						this.files = new Set();
						this.categories = new Set();
						this.activeFiles = [];
						this.activeCategories = [];
						this.search = "";

						if (Number(this.selectedTemplateIndex) === -1) return;

						const template = this.templates[Number(this.selectedTemplateIndex)];

						const res = await fetch(template.github_directory_url);

						if(!res.ok) {
							alert("Failed to load aliases");
							return;
						}

						const aliasFiles = await res.json();

						for (const aliasFile of aliasFiles) {
							if (template.exclude_files.includes(aliasFile.name)) continue;

							const fileRes = await fetch(aliasFile.download_url);

							if (!fileRes.ok) continue;

							const data = await fileRes.text();
							this.files.add(aliasFile.name);

							let skippedCategories = 0;
							let currentCategory = "";
							const lines = data.split("\n");
							
							for (let i = 0; i < lines.length; i++) {
								const line = lines[i];

								if (line.startsWith(template.category_prefix)) {
									if (skippedCategories < template.skip_categories) {
										if (template.is_category_newline) {
											for (let j = i; j < lines.length; j++) {
												if (lines[j].startsWith(template.category_prefix)) {
													i += j + 1;
													break;
												}
											}
										}

										skippedCategories++;
										continue;
									}

									if (template.is_category_newline) {
										const categoryMatch = lines[++i].trim().replace(template.category_prefix, "").trim();
										if (categoryMatch) {
											currentCategory = categoryMatch;
											this.categories.add(currentCategory);
										}
										continue;
									} else {
										const categoryMatch = line.replace(template.category_prefix, "").trim();
										if (categoryMatch) {
											currentCategory = categoryMatch;
											this.categories.add(currentCategory);
										}
										continue;
									}
								}

								if (!line.startsWith(".")) continue;

								const [alias, ...textParts] = line.split(" ");
								const text = textParts.join(" ");
								this.aliases.push({
									file: aliasFile.name,
									fileHref: aliasFile.html_url,
									category: currentCategory,
									alias,
									text,
								});
							}
						}

						this.activeFiles = Array.from(this.files);
						this.activeCategories = Array.from(this.categories);
					},

					selectAll(type, isChecked) {
						if (type === "files") {
							this.activeFiles = isChecked ? Array.from(this.files) : [];
						}
						if (type === "categories") {
							this.activeCategories = isChecked ? Array.from(this.categories) : [];
						}
					},

					areAllSelected(type) {
						if (type === "files") {
							return this.activeFiles.length === this.files.size;
						}
						if (type === "categories") {
							return this.activeCategories.length === this.categories.size;
						}
					},

					toggleFilter(type) {
						if (type === "file") {
							this.fileFilterOpen = !this.fileFilterOpen;
							this.categoryFilterOpen = false;
						}
						if (type === "category") {
							this.categoryFilterOpen = !this.categoryFilterOpen;
							this.fileFilterOpen = false;
						}
					},

					clearSearch() {
						this.search = "";
					},

					highlight(text) {
						if (!this.search) return text;
						const regex = new RegExp(`(${this.search})`, "gi");
						return text.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
					},

					applyFilter(type, value, disableOthers = false) {
						if (type === "file") {
							if (disableOthers) {
								this.activeFiles = [value];
							} else {
								if (this.activeFiles.includes(value)) {
									this.activeFiles = this.activeFiles.filter((file) => file !== value);
								} else {
									this.activeFiles.push(value);
								}
							}
						}
						if (type === "category") {
							if (disableOthers) {
								this.activeCategories = [value];
							} else {
								if (this.activeCategories.includes(value)) {
									this.activeCategories = this.activeCategories.filter((category) => category !== value);
								} else {
									this.activeCategories.push(value);
								}
							}
						}
					},

					get filteredAliases() {
						if (this.activeFiles.length === 0 || this.activeCategories.length === 0) {
							return [];
						}
						return this.aliases.filter((alias) => {
							const matchesFile = this.activeFiles.length === 0 || this.activeFiles.includes(alias.file);
							const matchesCategory = this.activeCategories.length === 0 || this.activeCategories.includes(alias.category);
							const matchesSearch =
								alias.alias.toLowerCase().includes(this.search.toLowerCase()) ||
								alias.text.toLowerCase().includes(this.search.toLowerCase());

							return matchesFile && matchesCategory && matchesSearch;
						});
					},

					async init() {
						await this.fetchTemplates();

						this.activeFiles = Array.from(this.files);
						this.activeCategories = Array.from(this.categories);
					},
				};
			}
		</script>
	</body>
</html>
