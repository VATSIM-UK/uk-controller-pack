<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
		<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
		<title>VATSIM-UK Alias Preview</title>
	</head>
	<body>
		<div class="container mx-auto p-4" x-data="aliasApp">
			<h1 class="text-4xl text-center">Alias Preview</h1>
			<p class="text-center">
				This page is a preview of the aliases in the UK Controller Pack. It is updated automatically from the GitHub repository.
			</p>
			<p class="text-center" x-text="status"></p>
			<p class="text-center font-semibold mt-2">
				Showing <span x-text="filteredAliases.length"></span> of <span x-text="aliases.length"></span> aliases
			</p>

			<div class="flex flex-row items-center justify-center">
				<input type="text" x-model="search" class="w-full p-2 my-2 border border-gray-400 rounded-md" placeholder="Search..." />
				<button @click="clearSearch">
					<span class="material-symbols-outlined mt-2 mx-2">cancel</span>
				</button>
			</div>

			<div class="flex flex-row items-start justify-between font-bold text-lg p-2">
				<div class="w-1/4 flex flex-col items-center relative">
					<div class="flex items-center justify-center">
						<p>File</p>
						<button @click="toggleFilter('file')" class="focus:outline-none">
							<span class="material-symbols-outlined mt-2 mx-2">filter_alt</span>
						</button>
					</div>
					<div
						x-show="fileFilterOpen"
						class="absolute bg-white border border-gray-300 rounded shadow-lg z-10 p-2 w-full"
						style="top: 100%"
						@click.away="fileFilterOpen = false"
					>
						<label class="flex items-center mb-2">
							<input
								type="checkbox"
								@click="selectAll('files', $event.target.checked)"
								:checked="areAllSelected('files')"
								class="form-checkbox"
							/>
							<span class="ml-2">Select All</span>
						</label>
						<template x-for="file in Array.from(files)">
							<label class="flex items-center">
								<input type="checkbox" x-model="activeFiles" :value="file" class="form-checkbox" />
								<span class="ml-2" x-text="file"></span>
							</label>
						</template>
					</div>
				</div>

				<div class="w-1/4 flex flex-col items-center relative">
					<div class="flex items-center justify-center">
						<p>Category</p>
						<button @click="toggleFilter('category')" class="focus:outline-none">
							<span class="material-symbols-outlined mt-2 mx-2">filter_alt</span>
						</button>
					</div>
					<div
						x-show="categoryFilterOpen"
						class="absolute bg-white border border-gray-300 rounded shadow-lg z-10 p-2 w-full"
						style="top: 100%"
						@click.away="categoryFilterOpen = false"
					>
						<label class="flex items-center mb-2">
							<input
								type="checkbox"
								@click="selectAll('categories', $event.target.checked)"
								:checked="areAllSelected('categories')"
								class="form-checkbox"
							/>
							<span class="ml-2">Select All</span>
						</label>
						<template x-for="category in Array.from(categories)">
							<label class="flex items-center">
								<input type="checkbox" x-model="activeCategories" :value="category" class="form-checkbox" />
								<span class="ml-2" x-text="category"></span>
							</label>
						</template>
					</div>
				</div>

				<p class="w-1/4 text-center">Alias</p>
				<p class="w-1/4 text-center">Text</p>
			</div>

			<span class="h-1 bg-gray-400 w-full block"></span>

			<div id="alias-list" class="flex flex-col">
				<template x-for="alias in filteredAliases" :key="alias.file + alias.alias">
					<div class="flex flex-row items-start justify-between p-2 border-b border-gray-400">
						<a
							class="text-center w-1/4 text-blue-600 hover:text-blue-800 hover:underline"
							:href="alias.fileHref"
							target="_blank"
							x-text="alias.file"
						></a>

						<p class="text-center w-1/4" x-text="alias.category"></p>
						<p class="text-center w-1/4" x-html="highlight(alias.alias)"></p>
						<p class="text-center w-1/4" x-html="highlight(alias.text)"></p>
					</div>
				</template>
			</div>
		</div>

		<script>
			function aliasApp() {
				return {
					aliases: [],
					files: new Set(),
					categories: new Set(),
					activeFiles: [],
					activeCategories: [],
					search: "",
					status: "Loading...",
					fileFilterOpen: false,
					categoryFilterOpen: false,

					async fetchAliases() {
						const res = await fetch("https://api.github.com/repos/VATSIM-UK/uk-controller-pack/contents/UK/Data/Alias?ref=main");
						const aliasFiles = await res.json();
						for (const aliasFile of aliasFiles) {
							const fileRes = await fetch(aliasFile.download_url);
							const data = await fileRes.text();
							this.files.add(aliasFile.name);

							let currentCategory = "";
							const lines = data.split("\n");

							for (let i = 0; i < lines.length; i++) {
								line = lines[i];

								if (line.startsWith("=") && i !== 0) {
									const categoryMatch = lines[++i].trim().replace(/=+/g, "").trim();
									if (categoryMatch) {
										currentCategory = categoryMatch;
										this.categories.add(currentCategory);
									}
									continue;
								}

								if (!line.startsWith(".")) continue;

								const [alias, ...textParts] = line.split(" ");
								const text = textParts.join(" ");
								this.aliases.push({
									file: aliasFile.name,
									fileHref: aliasFile.html_url,
									category: currentCategory,
									alias,
									text,
								});
							}
						}
						this.status = `${this.aliases.length} aliases loaded`;
					},

					selectAll(type, isChecked) {
						if (type === "files") {
							this.activeFiles = isChecked ? Array.from(this.files) : [];
						} else if (type === "categories") {
							this.activeCategories = isChecked ? Array.from(this.categories) : [];
						}
					},

					areAllSelected(type) {
						if (type === "files") {
							return this.activeFiles.length === this.files.size;
						} else if (type === "categories") {
							return this.activeCategories.length === this.categories.size;
						}
					},

					toggleFilter(type) {
						if (type === "file") this.fileFilterOpen = !this.fileFilterOpen;
						if (type === "category") this.categoryFilterOpen = !this.categoryFilterOpen;
					},

					clearSearch() {
						this.search = "";
					},

					highlight(text) {
						if (!this.search) return text;
						const regex = new RegExp(`(${this.search})`, "gi");
						return text.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
					},

					get filteredAliases() {
						return this.aliases.filter((alias) => {
							const matchesFile = this.activeFiles.length > 0 && this.activeFiles.includes(alias.file);
							const matchesCategory = this.activeCategories.length > 0 && this.activeCategories.includes(alias.category);
							const matchesSearch =
								alias.alias.toLowerCase().includes(this.search.toLowerCase()) ||
								alias.text.toLowerCase().includes(this.search.toLowerCase());

							return matchesFile && matchesCategory && matchesSearch;
						});
					},

					async init() {
						await this.fetchAliases();

						this.activeFiles = Array.from(this.files);
						this.activeCategories = Array.from(this.categories);
					},
				};
			}
		</script>
	</body>
</html>
